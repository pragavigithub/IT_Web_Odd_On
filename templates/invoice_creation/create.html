{% extends "base.html" %}

{% block title %}Invoice Creation - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="h4 mb-0">Invoice Creation</h2>
                    <p class="text-muted mb-0">Create invoice using serial number validation</p>
                </div>
                <a href="{{ url_for('invoice_creation.index') }}" class="btn btn-secondary">
                    <i data-feather="arrow-left"></i> Back to Invoices
                </a>
            </div>
        </div>
    </div>

    <!-- Main Form Row -->
    <div class="row mb-4">
        <!-- Invoice Details Section -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h5 class="mb-0"><i data-feather="file-text"></i> Invoice Details</h5>
                </div>
                <div class="card-body">
                    <form id="invoiceForm" method="POST">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="customerCode">Customer Code <span class="text-danger">*</span></label>
                                    <select class="form-control" id="customerCode" name="customer_code" required>
                                        <option value="">Select Customer...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="invoiceDate">Invoice Date</label>
                                    <input type="date" class="form-control" id="invoiceDate" name="invoice_date" readonly>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Add Serial Items Section -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i data-feather="plus-square"></i> Add Serial Items</h5>
                        <small class="badge badge-light">Line by Line Entry</small>
                    </div>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="serialNumberInput">Line <span id="currentLineDisplay">1</span> &nbsp;&nbsp;&nbsp; Serial Number</label>
                        <div class="d-flex align-items-center">
                            <div class="serial-line-number bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 30px; height: 30px; min-width: 30px;">
                                <span id="currentLineNumber">1</span>
                            </div>
                            <input type="text" class="form-control mr-2" id="serialNumberInput" 
                                   placeholder="Enter serial number and press Tab/Enter">
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3">
                        <button type="button" class="btn btn-outline-secondary" id="clearAllBtn">
                            <i data-feather="trash-2"></i> Clear All
                        </button>
                        <button type="button" class="btn btn-info" id="aboutAddingBtn">
                            <i data-feather="info"></i> About Real-time Adding
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Serial Items Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i data-feather="list"></i> Serial Items</h5>
                        <span class="badge badge-light" id="itemCount">0 Items</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0" id="serialItemsTable">
                            <thead style="background-color: #f8f9fa;">
                                <tr>
                                    <th style="width: 60px;">Line</th>
                                    <th style="width: 120px;">Serial Number</th>
                                    <th style="width: 120px;">Item Code</th>
                                    <th>Item Description</th>
                                    <th style="width: 100px;">From WH</th>
                                    <th style="width: 100px;">To WH</th>
                                    <th style="width: 100px;">Validation</th>
                                    <th style="width: 60px;">Qty</th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="serialItemsBody">
                                <!-- Items will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>
                    <div id="noItemsMessage" class="text-center py-5 text-muted">
                        <i data-feather="inbox" style="width: 48px; height: 48px;"></i>
                        <p class="mt-2 mb-0">No serial items added yet</p>
                        <small>Enter serial numbers above to start building the invoice</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h2 class="card-title mb-0" id="validatedCount">0</h2>
                    <p class="card-text mb-0">Validated Items</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h2 class="card-title mb-0" id="failedCount">0</h2>
                    <p class="card-text mb-0">Failed Items</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h2 class="card-title mb-0" id="totalCount">0</h2>
                    <p class="card-text mb-0">Total Items</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Button -->
    <div class="row">
        <div class="col-12 text-center">
            <button type="button" class="btn btn-primary btn-lg" id="submitForQCBtn" disabled>
                <i data-feather="check-circle"></i> Submit for QC Approval
            </button>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <div class="mt-3">
                    <h6 id="loadingMessage">Processing...</h6>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- About Modal -->
<div class="modal fade" id="aboutModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">About Real-time Adding</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h6><i data-feather="info"></i> How the system works:</h6>
                <ul class="list-unstyled">
                    <li><i data-feather="arrow-right"></i> Enter a serial number in the input field</li>
                    <li><i data-feather="arrow-right"></i> Press <kbd>Tab</kbd> to validate and auto-fetch details from SAP</li>
                    <li><i data-feather="arrow-right"></i> Press <kbd>Enter</kbd> to add the validated item to the invoice</li>
                    <li><i data-feather="arrow-right"></i> Items are automatically validated against SAP B1 inventory</li>
                    <li><i data-feather="arrow-right"></i> Review the summary before submitting for QC approval</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Ensure jQuery is available and initialize properly
document.addEventListener('DOMContentLoaded', function() {
    // Wait for jQuery to be fully loaded
    if (typeof $ === 'undefined') {
        console.error('jQuery is not loaded!');
        return;
    }
    
    console.log('Invoice Creation page loaded with jQuery version:', $.fn.jquery);
    
    // Initialize page after jQuery is confirmed loaded
    initializeInvoiceCreation();
});

function initializeInvoiceCreation() {
    console.log('Initializing Invoice Creation functionality');
    let serialNumbers = [];
    let serialLookupData = {};
    let currentLine = 1;

    // Set current date
    const today = new Date();
    $('#invoiceDate').val(today.toISOString().split('T')[0]);

    // Load business partners on page load
    loadBusinessPartners();
    updateItemCount();

    // Event handlers
    $('#serialNumberInput').on('keydown', function(e) {
        if (e.which === 9) { // Tab key
            e.preventDefault();
            autoFetchSerialDetails();
        } else if (e.which === 13) { // Enter key
            e.preventDefault();
            addSerialNumber();
        }
    });

    $('#clearAllBtn').on('click', clearAllItems);
    $('#aboutAddingBtn').on('click', function() {
        $('#aboutModal').modal('show');
    });
    $('#submitForQCBtn').on('click', submitInvoice);

    function loadBusinessPartners() {
        console.log('🔄 Loading business partners...');
        
        // Add manual input option first
        let customerSelect = $('#customerCode');
        customerSelect.empty().append('<option value="">Select Customer...</option>');
        customerSelect.append('<option value="manual">Enter Customer Code Manually</option>');
        
        $.ajax({
            url: '/invoice_creation/api/business-partners',
            method: 'GET',
            timeout: 15000,
            success: function(response) {
                console.log('Business partners response:', response);
                if (response.success && response.business_partners) {
                    // Clear and rebuild dropdown
                    customerSelect.empty().append('<option value="">Select Customer...</option>');
                    customerSelect.append('<option value="manual">Enter Customer Code Manually</option>');
                    
                    response.business_partners.forEach(function(partner) {
                        let cardName = partner.CardName || 'N/A';
                        customerSelect.append(`<option value="${partner.CardCode}">${partner.CardCode} - ${cardName}</option>`);
                    });
                    console.log('Loaded', response.business_partners.length, 'business partners');
                } else {
                    console.warn('SAP B1 unavailable - using offline mode');
                }
            },
            error: function(xhr, status, error) {
                console.warn('Business partners API error:', error);
                console.log('Running in offline mode - no fallback needed, handled by server');
            }
        });
    }

    function autoFetchSerialDetails() {
        let serialNumber = $('#serialNumberInput').val().trim();
        if (!serialNumber) {
            console.log('⚠️ No serial number entered');
            showTemporaryMessage('Please enter a serial number first', 'warning');
            return;
        }

        console.log('🔍 Fetching details for serial number:', serialNumber);
        showLoading('Validating serial number with SAP B1...');

        $.ajax({
            url: '/invoice_creation/api/validate-serial-number',
            method: 'GET',
            data: { serial_number: serialNumber },
            timeout: 15000,
            success: function(response) {
                hideLoading();
                console.log('Serial validation response:', response);
                
                if (response.success && response.item_data) {
                    // Store the validated data for adding
                    window.currentSerialData = response.item_data;
                    window.currentSerialData.serialNumber = serialNumber;
                    console.log('Serial data validated and stored:', response.item_data);
                    
                    // Auto-fill customer if CardCode is available
                    if (response.item_data.CardCode && response.item_data.CardCode !== '') {
                        let customerSelect = $('#customerCode');
                        let existingOption = customerSelect.find(`option[value="${response.item_data.CardCode}"]`);
                        
                        if (existingOption.length > 0) {
                            customerSelect.val(response.item_data.CardCode);
                            console.log('Auto-filled customer:', response.item_data.CardCode);
                        } else {
                            // Add customer option if not exists
                            let customerName = response.item_data.CardName || response.item_data.CustomerName || 'Unknown Customer';
                            customerSelect.append(`<option value="${response.item_data.CardCode}">${response.item_data.CardCode} - ${customerName}</option>`);
                            customerSelect.val(response.item_data.CardCode);
                            console.log('Added and auto-filled customer:', response.item_data.CardCode);
                        }
                    }
                    
                    // Show success message
                    showTemporaryMessage(`✅ Serial number "${serialNumber}" validated successfully! Customer auto-filled. Press Enter to add.`, 'success');
                } else {
                    console.warn('Serial number not found:', response.error || 'Unknown error');
                    showTemporaryMessage(`⚠️ Serial number "${serialNumber}" not found in SAP B1 inventory.`, 'warning');
                    window.currentSerialData = null;
                }
            },
            error: function(xhr, status, error) {
                hideLoading();
                console.error('❌ Serial validation error:', error, xhr.responseJSON);
                let errorMessage = 'SAP B1 connection failed. Using offline mode.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                showTemporaryMessage(errorMessage, 'warning');
                
                // Try to use fallback data for demo
                window.currentSerialData = {
                    ItemCode: 'MI Phone',
                    ItemName: 'RAHUL PHONE', 
                    DistNumber: serialNumber,
                    WhsCode: '7000-FG',
                    CardCode: 'CUS0028',
                    CardName: 'RAHUL PHONE CUSTOMER'
                };
                
                // Auto-fill customer with fallback data
                let customerSelect = $('#customerCode');
                if (customerSelect.find('option[value="CUS0028"]').length === 0) {
                    customerSelect.append('<option value="CUS0028">CUS0028 - RAHUL PHONE CUSTOMER</option>');
                }
                customerSelect.val('CUS0028');
                
                showTemporaryMessage('🔄 Using offline mode. Press Enter to add item.', 'info');
            }
        });
    }

    function addSerialNumber() {
        let serialNumber = $('#serialNumberInput').val().trim();
        
        if (!serialNumber) {
            showTemporaryMessage('Please enter a serial number first.', 'warning');
            return;
        }

        // Check if serial number already exists
        if (serialNumbers.some(item => item.serialNumber === serialNumber)) {
            showTemporaryMessage('Serial number already added to this invoice.', 'warning');
            return;
        }

        let itemData = window.currentSerialData;
        
        if (itemData) {
            // Add validated item
            serialNumbers.push({
                line: currentLine,
                serialNumber: serialNumber,
                itemCode: itemData.ItemCode,
                itemName: itemData.ItemName,
                fromWH: itemData.WhsCode,
                toWH: '', // Empty for invoice
                validation: 'Valid',
                qty: 1,
                status: 'validated'
            });
            console.log('Added validated serial number:', serialNumber);
        } else {
            // Add unvalidated item
            serialNumbers.push({
                line: currentLine,
                serialNumber: serialNumber,
                itemCode: 'N/A',
                itemName: 'Validation Failed',
                fromWH: 'N/A',
                toWH: 'N/A',
                validation: 'Failed',
                qty: 0,
                status: 'failed'
            });
            console.log('Added failed serial number:', serialNumber);
        }

        updateSerialItemsTable();
        updateSummaryCards();
        updateItemCount();
        
        // Clear input and move to next line
        $('#serialNumberInput').val('');
        currentLine++;
        $('#currentLineNumber').text(currentLine);
        $('#currentLineDisplay').text(currentLine);
        window.currentSerialData = null;
        
        // Enable submit button if there are validated items
        const hasValidItems = serialNumbers.some(item => item.status === 'validated');
        $('#submitForQCBtn').prop('disabled', !hasValidItems);
    }

    function updateSerialItemsTable() {
        const tbody = $('#serialItemsBody');
        const noItemsMessage = $('#noItemsMessage');
        
        if (serialNumbers.length === 0) {
            tbody.empty();
            noItemsMessage.show();
            return;
        }
        
        noItemsMessage.hide();
        tbody.empty();
        
        serialNumbers.forEach(function(item, index) {
            const validationBadge = item.status === 'validated' ? 
                '<span class="badge badge-success">Valid</span>' : 
                '<span class="badge badge-danger">Failed</span>';
            
            const row = `
                <tr>
                    <td>${item.line}</td>
                    <td>${item.serialNumber}</td>
                    <td>${item.itemCode}</td>
                    <td>${item.itemName}</td>
                    <td>${item.fromWH}</td>
                    <td>${item.toWH}</td>
                    <td>${validationBadge}</td>
                    <td>${item.qty}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeSerial(${index})">
                            <i data-feather="trash-2"></i> Delete
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
        
        // Re-initialize feather icons
        feather.replace();
    }

    function updateSummaryCards() {
        const validatedItems = serialNumbers.filter(item => item.status === 'validated').length;
        const failedItems = serialNumbers.filter(item => item.status === 'failed').length;
        const totalItems = serialNumbers.length;
        
        $('#validatedCount').text(validatedItems);
        $('#failedCount').text(failedItems);
        $('#totalCount').text(totalItems);
    }

    function updateItemCount() {
        $('#itemCount').text(serialNumbers.length + ' Items');
    }

    function clearAllItems() {
        if (serialNumbers.length === 0) {
            showTemporaryMessage('No items to clear.', 'info');
            return;
        }
        
        if (confirm('Are you sure you want to clear all serial items?')) {
            serialNumbers = [];
            currentLine = 1;
            $('#currentLineNumber').text(currentLine);
            $('#currentLineDisplay').text(currentLine);
            $('#serialNumberInput').val('');
            
            updateSerialItemsTable();
            updateSummaryCards();
            updateItemCount();
            
            $('#submitForQCBtn').prop('disabled', true);
            showTemporaryMessage('All items cleared.', 'info');
        }
    }

    function submitInvoice() {
        const customerCode = $('#customerCode').val();
        const invoiceDate = $('#invoiceDate').val();
        
        if (!customerCode) {
            showTemporaryMessage('Please select a customer first.', 'warning');
            return;
        }
        
        const validatedItems = serialNumbers.filter(item => item.status === 'validated');
        if (validatedItems.length === 0) {
            showTemporaryMessage('Please add at least one validated serial number.', 'warning');
            return;
        }
        
        const invoiceData = {
            customer_code: customerCode,
            invoice_date: invoiceDate,
            serial_items: validatedItems.map(item => ({
                serial_number: item.serialNumber,
                item_code: item.itemCode,
                item_name: item.itemName,
                warehouse: item.fromWH,
                quantity: item.qty
            }))
        };
        
        console.log('Submitting invoice:', invoiceData);
        showLoading('Creating invoice document...');
        
        $.ajax({
            url: '/invoice_creation/create',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(invoiceData),
            success: function(response) {
                hideLoading();
                if (response.success) {
                    showTemporaryMessage('Invoice created successfully!', 'success');
                    setTimeout(function() {
                        window.location.href = '/invoice_creation/';
                    }, 2000);
                } else {
                    showTemporaryMessage('Failed to create invoice: ' + response.error, 'danger');
                }
            },
            error: function(xhr, status, error) {
                hideLoading();
                console.error('Invoice creation error:', error);
                showTemporaryMessage('Error creating invoice: ' + error, 'danger');
            }
        });
    }

    // Global function for removing serial numbers
    window.removeSerial = function(index) {
        if (confirm('Are you sure you want to remove this serial number?')) {
            serialNumbers.splice(index, 1);
            updateSerialItemsTable();
            updateSummaryCards();
            updateItemCount();
            
            const hasValidItems = serialNumbers.some(item => item.status === 'validated');
            $('#submitForQCBtn').prop('disabled', !hasValidItems);
        }
    };

    function showLoading(message) {
        $('#loadingMessage').text(message);
        $('#loadingModal').modal('show');
    }

    function hideLoading() {
        $('#loadingModal').modal('hide');
    }

    function showTemporaryMessage(message, type) {
        const alertClass = `alert-${type}`;
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
                ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        `;
        
        $('body').append(alertHtml);
        
        // Auto-dismiss after 3 seconds
        setTimeout(function() {
            $('.alert').alert('close');
        }, 3000);
    }
}
</script>
{% endblock %}