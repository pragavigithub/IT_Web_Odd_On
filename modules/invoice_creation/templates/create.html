{% extends "base.html" %}

{% block title %}Create Invoice - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Create New Invoice</h2>
                <a href="{{ url_for('invoice_creation.index') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Invoices
                </a>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Invoice Details</h5>
                        </div>
                        <div class="card-body">
                            <form id="invoiceForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="customerCode">Customer Code <span class="text-danger">*</span></label>
                                            <select class="form-control" id="customerCode" name="customer_code" required>
                                                <option value="">Select Customer...</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="invoiceDate">Invoice Date</label>
                                            <input type="date" class="form-control" id="invoiceDate" name="invoice_date" 
                                                   value="" readonly>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0">Serial Numbers</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="serialNumberInput">Enter Serial Number</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="serialNumberInput" 
                                           placeholder="Enter serial number and press Enter">
                                    <div class="input-group-append">
                                        <button class="btn btn-primary" type="button" id="addSerialBtn">
                                            <i class="fas fa-plus"></i> Add
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div id="serialNumbersList" class="mt-3">
                                <!-- Serial numbers will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Invoice Summary</h5>
                        </div>
                        <div class="card-body">
                            <div id="invoiceSummary">
                                <p class="text-muted">Add serial numbers to see invoice summary</p>
                            </div>
                            
                            <hr>
                            
                            <button type="button" class="btn btn-success btn-block" id="createInvoiceBtn" disabled>
                                <i class="fas fa-file-invoice"></i> Create Invoice
                            </button>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0">Instructions</h6>
                        </div>
                        <div class="card-body">
                            <ol class="small">
                                <li>Select a customer from the dropdown</li>
                                <li>Enter serial numbers one by one</li>
                                <li>System will automatically group items</li>
                                <li>Review the summary and create invoice</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <div class="mt-3">
                    <h6 id="loadingMessage">Processing...</h6>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    let serialNumbers = [];
    let serialLookupData = {};

    // Load business partners on page load
    loadBusinessPartners();

    // Serial number input handling
    $('#serialNumberInput').on('keypress', function(e) {
        if (e.which === 13) { // Enter key
            e.preventDefault();
            addSerialNumber();
        }
    });

    $('#addSerialBtn').on('click', addSerialNumber);
    $('#createInvoiceBtn').on('click', createInvoice);

    function loadBusinessPartners() {
        $.ajax({
            url: '/invoice_creation/api/business-partners',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    let customerSelect = $('#customerCode');
                    customerSelect.empty().append('<option value="">Select Customer...</option>');
                    
                    response.business_partners.forEach(function(partner) {
                        customerSelect.append(`<option value="${partner.CardCode}">${partner.CardCode} - ${partner.CardName}</option>`);
                    });
                } else {
                    console.error('Failed to load business partners:', response.error);
                    // Show offline fallback
                    let customerSelect = $('#customerCode');
                    customerSelect.empty().append('<option value="">SAP B1 Offline - Enter manually</option>');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading business partners:', error);
                // Show offline fallback
                let customerSelect = $('#customerCode');
                customerSelect.empty().append('<option value="">SAP B1 Offline - Enter manually</option>');
            }
        });
    }

    function addSerialNumber() {
        let serialNumber = $('#serialNumberInput').val().trim();
        if (!serialNumber) {
            alert('Please enter a serial number');
            return;
        }

        if (serialNumbers.includes(serialNumber)) {
            alert('Serial number already added');
            return;
        }

        showLoading('Looking up serial number...');

        $.ajax({
            url: '/invoice_creation/api/lookup_serial',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ serial_number: serialNumber }),
            success: function(response) {
                hideLoading();
                if (response.success) {
                    serialNumbers.push(serialNumber);
                    serialLookupData[serialNumber] = response.data;
                    $('#serialNumberInput').val('');
                    updateSerialNumbersList();
                    updateInvoiceSummary();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                hideLoading();
                let errorMessage = 'Error looking up serial number';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }
                alert(errorMessage);
            }
        });
    }

    function removeSerialNumber(serialNumber) {
        let index = serialNumbers.indexOf(serialNumber);
        if (index > -1) {
            serialNumbers.splice(index, 1);
            delete serialLookupData[serialNumber];
            updateSerialNumbersList();
            updateInvoiceSummary();
        }
    }

    function updateSerialNumbersList() {
        let html = '';
        serialNumbers.forEach(function(serialNumber) {
            let data = serialLookupData[serialNumber];
            html += `
                <div class="border rounded p-2 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${serialNumber}</strong><br>
                            <small class="text-muted">${data.ItemCode} - ${data.itemName}</small><br>
                            <small class="text-muted">${data.WhsCode} - ${data.WhsName}</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSerialNumber('${serialNumber}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        if (html === '') {
            html = '<p class="text-muted">No serial numbers added yet</p>';
        }

        $('#serialNumbersList').html(html);
    }

    function updateInvoiceSummary() {
        if (serialNumbers.length === 0) {
            $('#invoiceSummary').html('<p class="text-muted">Add serial numbers to see invoice summary</p>');
            $('#createInvoiceBtn').prop('disabled', true);
            return;
        }

        // Group by item code
        let items = {};
        serialNumbers.forEach(function(serialNumber) {
            let data = serialLookupData[serialNumber];
            let key = data.ItemCode;
            if (!items[key]) {
                items[key] = {
                    code: data.ItemCode,
                    name: data.itemName,
                    warehouse: data.WhsCode,
                    quantity: 0,
                    serials: []
                };
            }
            items[key].quantity++;
            items[key].serials.push(serialNumber);
        });

        let html = '<h6>Items Summary:</h6>';
        Object.values(items).forEach(function(item) {
            html += `
                <div class="mb-2">
                    <strong>${item.code}</strong><br>
                    <small>${item.name}</small><br>
                    <small class="text-muted">Warehouse: ${item.warehouse}</small><br>
                    <small class="text-muted">Quantity: ${item.quantity}</small>
                </div>
                <hr>
            `;
        });

        html += `<p><strong>Total Serial Numbers: ${serialNumbers.length}</strong></p>`;

        $('#invoiceSummary').html(html);
        
        // Enable create button if customer and serials are selected
        let customerSelected = $('#customerCode').val();
        $('#createInvoiceBtn').prop('disabled', !customerSelected || serialNumbers.length === 0);
    }

    $('#customerCode').on('change', function() {
        updateInvoiceSummary();
    });

    function createInvoice() {
        let customerCode = $('#customerCode').val();
        if (!customerCode) {
            alert('Please select a customer');
            return;
        }

        if (serialNumbers.length === 0) {
            alert('Please add at least one serial number');
            return;
        }

        showLoading('Creating invoice...');

        $.ajax({
            url: '/invoice_creation/api/create_invoice',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                customer_code: customerCode,
                serial_numbers: serialNumbers
            }),
            success: function(response) {
                hideLoading();
                if (response.success) {
                    alert('Invoice created successfully! Invoice #: ' + response.sap_doc_num);
                    window.location.href = '/invoice_creation/detail/' + response.invoice_id;
                } else {
                    alert('Error creating invoice: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                hideLoading();
                let errorMessage = 'Error creating invoice';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }
                alert(errorMessage);
            }
        });
    }

    function showLoading(message) {
        $('#loadingMessage').text(message);
        $('#loadingModal').modal('show');
    }

    function hideLoading() {
        $('#loadingModal').modal('hide');
    }

    // Make functions global for onclick handlers
    window.removeSerialNumber = removeSerialNumber;
});
</script>
{% endblock %}