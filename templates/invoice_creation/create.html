{% extends "base.html" %}

{% block title %}Invoice Creation - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="h4 mb-0">Invoice Creation</h2>
                    <p class="text-muted mb-0">Create invoice using serial number validation</p>
                </div>
                <a href="{{ url_for('invoice_creation.index') }}" class="btn btn-secondary">
                    <i data-feather="arrow-left"></i> Back to Invoices
                </a>
            </div>
        </div>
    </div>

    <!-- Main Form Row -->
    <div class="row mb-4">
        <!-- Invoice Details Section -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h5 class="mb-0"><i data-feather="file-text"></i> Invoice Details</h5>
                </div>
                <div class="card-body">
                    <form id="invoiceForm" method="POST">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="customerCode">Customer Code <span class="text-danger">*</span></label>
                                    <select class="form-control" id="customerCode" name="customer_code" required>
                                        <option value="">Select Customer...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="invoiceDate">Invoice Date</label>
                                    <input type="date" class="form-control" id="invoiceDate" name="invoice_date" readonly>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Add Serial Items Section -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i data-feather="plus-square"></i> Add Serial Items</h5>
                        <small class="badge badge-light">Line by Line Entry</small>
                    </div>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="serialNumberInput">Line <span id="currentLineDisplay">1</span> &nbsp;&nbsp;&nbsp; Serial Number</label>
                        <div class="d-flex align-items-center">
                            <div class="serial-line-number bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 30px; height: 30px; min-width: 30px;">
                                <span id="currentLineNumber">1</span>
                            </div>
                            <input type="text" class="form-control mr-2" id="serialNumberInput" 
                                   placeholder="Enter serial number and press Tab/Enter">
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3">
                        <button type="button" class="btn btn-outline-secondary" id="clearAllBtn">
                            <i data-feather="trash-2"></i> Clear All
                        </button>
                        <button type="button" class="btn btn-info" id="aboutAddingBtn">
                            <i data-feather="info"></i> About Real-time Adding
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Serial Items Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i data-feather="list"></i> Serial Items</h5>
                        <span class="badge badge-light" id="itemCount">0 Items</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0" id="serialItemsTable">
                            <thead style="background-color: #f8f9fa;">
                                <tr>
                                    <th style="width: 60px;">Line</th>
                                    <th style="width: 120px;">Serial Number</th>
                                    <th style="width: 120px;">Item Code</th>
                                    <th>Item Description</th>
                                    <th style="width: 100px;">From WH</th>
                                    <th style="width: 100px;">To WH</th>
                                    <th style="width: 100px;">Validation</th>
                                    <th style="width: 60px;">Qty</th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="serialItemsBody">
                                <!-- Items will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>
                    <div id="noItemsMessage" class="text-center py-5 text-muted">
                        <i data-feather="inbox" style="width: 48px; height: 48px;"></i>
                        <p class="mt-2 mb-0">No serial items added yet</p>
                        <small>Enter serial numbers above to start building the invoice</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h2 class="card-title mb-0" id="validatedCount">0</h2>
                    <p class="card-text mb-0">Validated Items</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h2 class="card-title mb-0" id="failedCount">0</h2>
                    <p class="card-text mb-0">Failed Items</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h2 class="card-title mb-0" id="totalCount">0</h2>
                    <p class="card-text mb-0">Total Items</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Button -->
    <div class="row">
        <div class="col-12 text-center">
            <button type="button" class="btn btn-primary btn-lg" id="submitForQCBtn" disabled>
                <i data-feather="check-circle"></i> Submit for QC Approval
            </button>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <div class="mt-3">
                    <h6 id="loadingMessage">Processing...</h6>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- About Modal -->
<div class="modal fade" id="aboutModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">About Real-time Adding</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h6><i data-feather="info"></i> How the system works:</h6>
                <ul class="list-unstyled">
                    <li><i data-feather="arrow-right"></i> Enter a serial number in the input field</li>
                    <li><i data-feather="arrow-right"></i> Press <kbd>Tab</kbd> to validate and auto-fetch details from SAP</li>
                    <li><i data-feather="arrow-right"></i> Press <kbd>Enter</kbd> to add the validated item to the invoice</li>
                    <li><i data-feather="arrow-right"></i> Items are automatically validated against SAP B1 inventory</li>
                    <li><i data-feather="arrow-right"></i> Review the summary before submitting for QC approval</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Ensure jQuery is available and initialize properly
document.addEventListener('DOMContentLoaded', function() {
    // Wait for jQuery to be fully loaded
    if (typeof $ === 'undefined') {
        console.error('jQuery is not loaded!');
        return;
    }
    
    console.log('Invoice Creation page loaded with jQuery version:', $.fn.jquery);
    
    // Initialize page after jQuery is confirmed loaded
    initializeInvoiceCreation();
});

function initializeInvoiceCreation() {
    console.log('Initializing Invoice Creation functionality');
    let currentInvoiceId = null;
    let currentLine = 1;

    // Set current date
    const today = new Date();
    $('#invoiceDate').val(today.toISOString().split('T')[0]);

    // Create draft invoice immediately on page load
    createDraftInvoice();

    // Load business partners on page load
    loadBusinessPartners();

    // Event handlers
    $('#serialNumberInput').on('keydown', function(e) {
        if (e.which === 9) { // Tab key
            e.preventDefault();
            autoFetchSerialDetails();
        } else if (e.which === 13) { // Enter key
            e.preventDefault();
            addSerialNumber();
        }
    });

    $('#clearAllBtn').on('click', clearAllItems);
    $('#aboutAddingBtn').on('click', function() {
        $('#aboutModal').modal('show');
    });
    $('#submitForQCBtn').on('click', submitInvoice);

    function createDraftInvoice() {
        console.log('üîÑ Creating draft invoice...');
        
        $.ajax({
            url: '/invoice_creation/create_draft',
            method: 'POST',
            success: function(response) {
                if (response.success && response.invoice_id) {
                    currentInvoiceId = response.invoice_id;
                    console.log('‚úÖ Draft invoice created with ID:', currentInvoiceId);
                    
                    // Load existing items if any
                    loadExistingItems();
                } else {
                    console.error('‚ùå Failed to create draft invoice:', response.error);
                    showTemporaryMessage('Failed to create draft invoice: ' + (response.error || 'Unknown error'), 'danger');
                }
            },
            error: function(xhr, status, error) {
                console.error('‚ùå Error creating draft invoice:', error);
                showTemporaryMessage('Error creating draft invoice. Please refresh the page.', 'danger');
            }
        });
    }

    function addRowToTable(itemData) {
        console.log('üîÑ Adding row to table:', itemData);
        
        const tbody = $('#serialItemsBody');
        const noItemsMessage = $('#noItemsMessage');
        
        // Hide no items message
        noItemsMessage.hide();
        
        const validationBadge = itemData.validation_status === 'validated' ? 
            '<span class="badge badge-success">Valid</span>' : 
            '<span class="badge badge-danger">Failed</span>';
        
        const row = `
            <tr class="table-row-item" data-item-id="${itemData.id}">
                <td><strong>${itemData.line_number}</strong></td>
                <td><code>${itemData.serial_number}</code></td>
                <td><strong>${itemData.item_code}</strong></td>
                <td>${itemData.item_description}</td>
                <td><span class="badge badge-info">${itemData.warehouse_code}</span></td>
                <td><span class="badge badge-secondary">-</span></td>
                <td>${validationBadge}</td>
                <td><strong>${itemData.quantity}</strong></td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeLineItem(${itemData.id})" title="Remove Item">
                        <i data-feather="trash-2" style="width: 14px; height: 14px;"></i> Delete
                    </button>
                </td>
            </tr>
        `;
        
        tbody.append(row);
        
        // Re-initialize feather icons for the new row
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
        
        console.log('‚úÖ Row added to table successfully');
        updateItemCount();
    }

    function loadExistingItems() {
        // This would load existing items from the database for the current invoice
        // For now, we'll start with an empty table since it's a new draft
        console.log('üîÑ Loading existing items for invoice:', currentInvoiceId);
        updateItemCount();
    }

    function loadBusinessPartners() {
        console.log('üîÑ Loading business partners...');
        
        // Add manual input option first
        let customerSelect = $('#customerCode');
        customerSelect.empty().append('<option value="">Select Customer...</option>');
        customerSelect.append('<option value="manual">Enter Customer Code Manually</option>');
        
        $.ajax({
            url: '/invoice_creation/api/business-partners',
            method: 'GET',
            timeout: 15000,
            success: function(response) {
                console.log('Business partners response:', response);
                if (response.success && response.business_partners) {
                    // Clear and rebuild dropdown
                    customerSelect.empty().append('<option value="">Select Customer...</option>');
                    customerSelect.append('<option value="manual">Enter Customer Code Manually</option>');
                    
                    response.business_partners.forEach(function(partner) {
                        let cardName = partner.CardName || 'N/A';
                        customerSelect.append(`<option value="${partner.CardCode}">${partner.CardCode} - ${cardName}</option>`);
                    });
                    console.log('Loaded', response.business_partners.length, 'business partners');
                } else {
                    console.warn('SAP B1 unavailable - using offline mode');
                }
            },
            error: function(xhr, status, error) {
                console.warn('Business partners API error:', error);
                console.log('Running in offline mode - no fallback needed, handled by server');
            }
        });
    }

    function autoFetchSerialDetails() {
        let serialNumber = $('#serialNumberInput').val().trim();
        if (!serialNumber) {
            console.log('‚ö†Ô∏è No serial number entered');
            showTemporaryMessage('Please enter a serial number first', 'warning');
            return;
        }

        console.log('üîç Fetching details for serial number:', serialNumber);
        showLoading('Validating serial number with SAP B1...');

        $.ajax({
            url: '/invoice_creation/api/validate-serial-number',
            method: 'GET',
            data: { serial_number: serialNumber },
            timeout: 15000,
            success: function(response) {
                hideLoading();
                console.log('Serial validation response:', response);
                
                if (response.success && response.item_data) {
                    // Store the validated data for adding
                    window.currentSerialData = response.item_data;
                    window.currentSerialData.serialNumber = serialNumber;
                    console.log('Serial data validated and stored:', response.item_data);
                    
                    // Auto-fill customer if CardCode is available
                    if (response.item_data.CardCode && response.item_data.CardCode !== '') {
                        let customerSelect = $('#customerCode');
                        let existingOption = customerSelect.find(`option[value="${response.item_data.CardCode}"]`);
                        
                        if (existingOption.length > 0) {
                            customerSelect.val(response.item_data.CardCode);
                            console.log('Auto-filled customer:', response.item_data.CardCode);
                        } else {
                            // Add customer option if not exists
                            let customerName = response.item_data.CardName || response.item_data.CustomerName || 'Unknown Customer';
                            customerSelect.append(`<option value="${response.item_data.CardCode}">${response.item_data.CardCode} - ${customerName}</option>`);
                            customerSelect.val(response.item_data.CardCode);
                            console.log('Added and auto-filled customer:', response.item_data.CardCode);
                        }
                    }
                    
                    // Show success message
                    showTemporaryMessage(`‚úÖ Serial number "${serialNumber}" validated successfully! Customer auto-filled. Press Enter to add.`, 'success');
                } else {
                    console.warn('Serial number not found:', response.error || 'Unknown error');
                    showTemporaryMessage(`‚ö†Ô∏è Serial number "${serialNumber}" not found in SAP B1 inventory.`, 'warning');
                    window.currentSerialData = null;
                }
            },
            error: function(xhr, status, error) {
                hideLoading();
                console.error('‚ùå Serial validation error:', error, xhr.responseJSON);
                let errorMessage = 'SAP B1 connection failed. Using offline mode.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                showTemporaryMessage(errorMessage, 'warning');
                
                // Try to use fallback data for demo
                window.currentSerialData = {
                    ItemCode: 'MI Phone',
                    ItemName: 'RAHUL PHONE', 
                    DistNumber: serialNumber,
                    WhsCode: '7000-FG',
                    CardCode: 'CUS0028',
                    CardName: 'RAHUL PHONE CUSTOMER'
                };
                
                // Auto-fill customer with fallback data
                let customerSelect = $('#customerCode');
                if (customerSelect.find('option[value="CUS0028"]').length === 0) {
                    customerSelect.append('<option value="CUS0028">CUS0028 - RAHUL PHONE CUSTOMER</option>');
                }
                customerSelect.val('CUS0028');
                
                showTemporaryMessage('üîÑ Using offline mode. Press Enter to add item.', 'info');
            }
        });
    }

    function addSerialNumber() {
        let serialNumber = $('#serialNumberInput').val().trim();
        
        if (!serialNumber) {
            showTemporaryMessage('Please enter a serial number first.', 'warning');
            return;
        }

        // Check if serial number already exists in current array
        if (serialNumbers.some(item => item.serialNumber === serialNumber)) {
            showTemporaryMessage('Serial number already added to this invoice.', 'warning');
            return;
        }

        let itemData = window.currentSerialData;
        console.log('üîç Current serial data for adding:', itemData);
        
        if (!itemData) {
            showTemporaryMessage('Please validate the serial number first by pressing Tab.', 'warning');
            return;
        }

        // Make API call to add item immediately to database (like Serial Item Transfer does)
        if (!currentInvoiceId) {
            showTemporaryMessage('No draft invoice available. Please refresh the page.', 'danger');
            return;
        }

        const addData = {
            serial_number: serialNumber
        };

        console.log('üì§ Adding serial item with data:', addData);
        showLoading('Adding item to invoice...');

        $.ajax({
            url: `/invoice_creation/${currentInvoiceId}/add_line_item`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(addData),
            success: function(response) {
                hideLoading();
                console.log('‚úÖ Serial item added successfully:', response);
                
                if (response.success && response.item_added && response.item_data) {
                    console.log('‚úÖ Item added to database:', response.item_data);
                    
                    // Add row to table immediately
                    addRowToTable(response.item_data);
                    
                    // Update customer dropdown if auto-detected
                    if (response.item_data.customer_code) {
                        let customerSelect = $('#customerCode');
                        let existingOption = customerSelect.find(`option[value="${response.item_data.customer_code}"]`);
                        
                        if (existingOption.length > 0) {
                            customerSelect.val(response.item_data.customer_code);
                        } else {
                            // Add customer option if not exists
                            let customerName = response.item_data.customer_name || 'Unknown Customer';
                            customerSelect.append(`<option value="${response.item_data.customer_code}">${response.item_data.customer_code} - ${customerName}</option>`);
                            customerSelect.val(response.item_data.customer_code);
                        }
                    }
                    
                    // Update summary and counters
                    updateSummaryCards();
                    
                    // Clear input and move to next line
                    $('#serialNumberInput').val('');
                    currentLine++;
                    $('#currentLineNumber').text(currentLine);
                    $('#currentLineDisplay').text(currentLine);
                    window.currentSerialData = null;
                    
                    // Enable submit button if we have validated items
                    $('#submitForQCBtn').prop('disabled', false);
                    
                    // Focus back to input
                    $('#serialNumberInput').focus();
                    
                    showTemporaryMessage(`‚úÖ Added "${serialNumber}" to invoice!`, 'success');
                } else {
                    showTemporaryMessage('Failed to add item: ' + (response.error || 'Unknown error'), 'danger');
                }
            },
            error: function(xhr, status, error) {
                hideLoading();
                console.error('‚ùå Failed to add serial item:', error, xhr.responseJSON);
                let errorMsg = 'Failed to add item to invoice';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                showTemporaryMessage(errorMsg, 'danger');
            }
        });
    }

    function updateSerialItemsTable() {
        console.log('üîÑ Updating Serial Items Table with', serialNumbers.length, 'items');
        
        const tbody = $('#serialItemsBody');
        const noItemsMessage = $('#noItemsMessage');
        
        if (serialNumbers.length === 0) {
            console.log('üìù No items - showing empty message');
            tbody.empty();
            noItemsMessage.show();
            return;
        }
        
        console.log('üìã Adding', serialNumbers.length, 'items to table');
        noItemsMessage.hide();
        tbody.empty();
        
        serialNumbers.forEach(function(item, index) {
            const validationBadge = item.status === 'validated' ? 
                '<span class="badge badge-success">Valid</span>' : 
                '<span class="badge badge-danger">Failed</span>';
            
            const row = `
                <tr class="table-row-item">
                    <td><strong>${item.line}</strong></td>
                    <td><code>${item.serialNumber}</code></td>
                    <td><strong>${item.itemCode}</strong></td>
                    <td>${item.itemName}</td>
                    <td><span class="badge badge-info">${item.fromWH}</span></td>
                    <td><span class="badge badge-secondary">${item.toWH}</span></td>
                    <td>${validationBadge}</td>
                    <td><strong>${item.qty}</strong></td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeSerial(${index})" title="Remove Item">
                            <i data-feather="trash-2" style="width: 14px; height: 14px;"></i> Delete
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
        
        // Re-initialize feather icons
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
        
        console.log('‚úÖ Table updated successfully');
    }

    function updateSummaryCards() {
        updateItemCount();
    }

    function removeLineItem(itemId) {
        if (!currentInvoiceId) {
            showTemporaryMessage('No invoice available', 'danger');
            return;
        }
        
        console.log('üóëÔ∏è Removing line item:', itemId);
        showLoading('Removing item...');
        
        $.ajax({
            url: `/invoice_creation/${currentInvoiceId}/remove_line_item/${itemId}`,
            method: 'DELETE',
            success: function(response) {
                hideLoading();
                if (response.success) {
                    // Remove the row from table
                    $(`tr[data-item-id="${itemId}"]`).remove();
                    
                    // Update counters
                    updateItemCount();
                    
                    // Show empty message if no items
                    if ($('#serialItemsBody tr').length === 0) {
                        $('#noItemsMessage').show();
                    }
                    
                    showTemporaryMessage('Item removed successfully', 'success');
                } else {
                    showTemporaryMessage('Failed to remove item: ' + (response.error || 'Unknown error'), 'danger');
                }
            },
            error: function(xhr, status, error) {
                hideLoading();
                console.error('‚ùå Error removing item:', error);
                showTemporaryMessage('Error removing item', 'danger');
            }
        });
    }

    function clearAllItems() {
        // For now, we'll disable this function since items are in database
        // Could implement by deleting all items from current invoice
        showTemporaryMessage('Clear all function not implemented yet', 'info');
    }

    function submitInvoice() {
        // Implementation for submitting invoice for QC
        showTemporaryMessage('Submit function not implemented yet', 'info');
    }

    // Updated summary calculation
    function updateItemCountOld() {
        const validatedItems = [];
        const failedItems = serialNumbers.filter(item => item.status === 'failed').length;
        const totalItems = serialNumbers.length;
        
        $('#validatedCount').text(validatedItems);
        $('#failedCount').text(failedItems);
        $('#totalCount').text(totalItems);
    }

    function updateItemCount() {
        $('#itemCount').text(serialNumbers.length + ' Items');
    }

    function clearAllItems() {
        if (serialNumbers.length === 0) {
            showTemporaryMessage('No items to clear.', 'info');
            return;
        }
        
        if (confirm('Are you sure you want to clear all serial items?')) {
            showLoading('Clearing all items...');
            
            $.ajax({
                url: '/invoice_creation/clear-session-items',
                method: 'POST',
                success: function(response) {
                    hideLoading();
                    if (response.success) {
                        serialNumbers = [];
                        currentLine = 1;
                        $('#currentLineNumber').text(currentLine);
                        $('#currentLineDisplay').text(currentLine);
                        $('#serialNumberInput').val('');
                        
                        updateSerialItemsTable();
                        updateSummaryCards();
                        updateItemCount();
                        
                        $('#submitForQCBtn').prop('disabled', true);
                        showTemporaryMessage('‚úÖ All items cleared.', 'success');
                    } else {
                        showTemporaryMessage('Failed to clear items: ' + response.error, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    hideLoading();
                    console.error('‚ùå Failed to clear items:', error);
                    showTemporaryMessage('Failed to clear items.', 'danger');
                }
            });
        }
    }

    function submitInvoice() {
        const customerCode = $('#customerCode').val();
        const invoiceDate = $('#invoiceDate').val();
        
        if (!customerCode) {
            showTemporaryMessage('Please select a customer first.', 'warning');
            return;
        }
        
        const validatedItems = serialNumbers.filter(item => item.status === 'validated');
        if (validatedItems.length === 0) {
            showTemporaryMessage('Please add at least one validated serial number.', 'warning');
            return;
        }
        
        // Get customer name from selected option
        const customerName = $('#customerCode option:selected').text().split(' - ')[1] || '';
        
        const invoiceData = {
            customer_code: customerCode,
            customer_name: customerName,
            invoice_date: invoiceDate,
            serial_items: validatedItems.map(item => ({
                serial_number: item.serialNumber,
                item_code: item.itemCode,
                item_name: item.itemName,
                warehouse: item.fromWH,
                quantity: item.qty
            }))
        };
        
        console.log('üì§ Submitting invoice for QC:', invoiceData);
        showLoading('Creating invoice document...');
        
        $.ajax({
            url: '/invoice_creation/create',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(invoiceData),
            success: function(response) {
                hideLoading();
                if (response.success) {
                    showTemporaryMessage(`‚úÖ Invoice ${response.invoice_number} created and sent for QC approval!`, 'success');
                    
                    // Clear session and local data
                    serialNumbers = [];
                    currentLine = 1;
                    $('#currentLineNumber').text(currentLine);
                    $('#currentLineDisplay').text(currentLine);
                    $('#serialNumberInput').val('');
                    $('#customerCode').val('');
                    
                    updateSerialItemsTable();
                    updateSummaryCards();
                    updateItemCount();
                    $('#submitForQCBtn').prop('disabled', true);
                    
                    // Redirect to invoice list after delay
                    setTimeout(function() {
                        window.location.href = '/invoice_creation/';
                    }, 3000);
                } else {
                    showTemporaryMessage('‚ùå Failed to create invoice: ' + response.error, 'danger');
                }
            },
            error: function(xhr, status, error) {
                hideLoading();
                console.error('‚ùå Invoice creation error:', error, xhr.responseJSON);
                let errorMsg = 'Error creating invoice';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                showTemporaryMessage('‚ùå ' + errorMsg, 'danger');
            }
        });
    }

    // Global function for removing serial numbers (using item ID like Serial Item Transfer)
    window.removeSerial = function(index) {
        const item = serialNumbers[index];
        if (!item) return;
        
        if (confirm(`Are you sure you want to remove serial number "${item.serialNumber}"?`)) {
            showLoading('Removing item...');
            
            $.ajax({
                url: `/invoice_creation/remove-serial-item/${item.id}`,
                method: 'POST',
                success: function(response) {
                    hideLoading();
                    if (response.success) {
                        // Remove from local array
                        serialNumbers.splice(index, 1);
                        
                        // Update displays
                        updateSerialItemsTable();
                        updateSummaryCards();
                        updateItemCount();
                        
                        const hasValidItems = serialNumbers.some(item => item.status === 'validated');
                        $('#submitForQCBtn').prop('disabled', !hasValidItems);
                        
                        showTemporaryMessage(`‚úÖ Removed "${item.serialNumber}" from invoice.`, 'success');
                    } else {
                        showTemporaryMessage('Failed to remove item: ' + response.error, 'danger');
                    }
                },
                error: function(xhr, status, error) {
                    hideLoading();
                    console.error('‚ùå Failed to remove item:', error);
                    showTemporaryMessage('Failed to remove item.', 'danger');
                }
            });
        }
    };

    function showLoading(message) {
        $('#loadingMessage').text(message);
        $('#loadingModal').modal('show');
    }

    function hideLoading() {
        $('#loadingModal').modal('hide');
    }

    function showTemporaryMessage(message, type) {
        const alertClass = `alert-${type}`;
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
                ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        `;
        
        $('body').append(alertHtml);
        
        // Auto-dismiss after 3 seconds
        setTimeout(function() {
            $('.alert').alert('close');
        }, 3000);
    }
}
</script>
{% endblock %}